// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  username      String?   @unique
  password      String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  portfolio     Portfolio?
  llmConfigs    LLMConfig[]
}

model Portfolio {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Analytics relation
  pageViews     PageView[]

  // ========== PERSONAL INFO ==========
  fullName      String?
  title         String?   // e.g., "Senior Frontend Developer"
  tagline       String?   // Short catchy phrase
  bio           String?   @db.Text
  avatar        String?
  coverImage    String?   // Hero background image
  cvUrl         String?   // URL to CV/Resume file

  // ========== CONTACT ==========
  email         String?
  phone         String?
  location      String?
  timezone      String?   // e.g., "Asia/Ho_Chi_Minh"

  // ========== SOCIAL LINKS (Legacy - keep for backward compatibility) ==========
  github        String?
  linkedin      String?
  twitter       String?
  website       String?
  dribbble      String?
  behance       String?
  youtube       String?
  instagram     String?
  medium        String?
  devto         String?
  stackoverflow String?
  codepen       String?

  // ========== SOCIAL LINKS (Dynamic Array) ==========
  // Format: [{ type: "github", url: "...", label?: "..." }, ...]
  socialLinks   Json?

  // ========== THEME & CUSTOMIZATION ==========
  template         String    @default("minimal")
  templateSettings Json?     // Template-specific settings (JSON object)
  primaryColor     String    @default("#3b82f6")
  secondaryColor   String?
  accentColor      String?
  fontFamily       String?   // "inter", "poppins", "roboto", etc.
  darkMode         Boolean   @default(false)

  // ========== SECTION VISIBILITY ==========
  showSkills       Boolean @default(true)
  showExperience   Boolean @default(true)
  showProjects     Boolean @default(true)
  showEducation    Boolean @default(true)
  showCertifications Boolean @default(true)
  showTestimonials Boolean @default(true)
  showBlog         Boolean @default(false)
  showAchievements Boolean @default(true)

  // ========== CONTENT (JSON) ==========
  skills         Json?
  experience     Json?
  education      Json?
  projects       Json?
  certifications Json?
  testimonials   Json?
  achievements   Json?
  blogPosts      Json?
  languages      Json?     // spoken languages
  interests      Json?     // hobbies/interests

  // ========== SEO & ANALYTICS ==========
  seoTitle          String?
  seoDescription    String?
  ogImage           String?
  googleAnalyticsId String?

  // ========== STATUS ==========
  isPublished   Boolean   @default(false)
  customDomain  String?   // for future custom domain support
  viewCount     Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model LLMConfig {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider      String    // openai, anthropic, google, groq
  apiKey        String    // stored encrypted
  model         String    // gpt-4, claude-3-sonnet, etc.
  isDefault     Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, provider])
}

// ========== ANALYTICS ==========
model PageView {
  id            String    @id @default(cuid())
  portfolioId   String
  portfolio     Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  // Visitor info
  visitorId     String?   // Anonymous visitor ID (from cookie/fingerprint)
  sessionId     String?   // Session tracking

  // Request info
  path          String    // e.g., "/johndoe" or "/johndoe/projects"
  referrer      String?   // Where they came from
  userAgent     String?   @db.Text

  // Geo info (from IP)
  country       String?
  city          String?
  region        String?

  // Device info
  device        String?   // "desktop", "mobile", "tablet"
  browser       String?   // "Chrome", "Safari", "Firefox"
  os            String?   // "Windows", "macOS", "iOS", "Android"

  // Timing
  duration      Int?      // Time spent on page in seconds

  createdAt     DateTime  @default(now())

  @@index([portfolioId])
  @@index([createdAt])
  @@index([visitorId])
}

// Aggregated daily stats for faster queries
model DailyStats {
  id            String    @id @default(cuid())
  portfolioId   String
  date          DateTime  @db.Date

  // Counts
  views         Int       @default(0)
  uniqueVisitors Int      @default(0)

  // Top sources
  topReferrers  Json?     // [{ referrer: "google.com", count: 10 }, ...]
  topCountries  Json?     // [{ country: "US", count: 50 }, ...]
  topDevices    Json?     // [{ device: "mobile", count: 30 }, ...]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([portfolioId, date])
  @@index([portfolioId])
  @@index([date])
}
